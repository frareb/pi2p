<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Déploiement de l'API sur un serveur</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.2/styles/github.min.css">
  </head>
  <body>
    <h1>Déploiement de l'API sur un serveur</h1>
    <p>
      Ce guide explique comment effectuer une mise en production de l'API, afin de pouvoir y connecter des <em>gateways</em>.
      L'entièreté de la procédure a été effectuée sur un serveur CentOS 7 ; toutefois, un administrateur système expérimenté saura modifier les commandes lorsque nécessaire afin d'adapter cette procédure à n'importe quel autre système.
    </p>
    <h2>Configuration préliminaire</h2>
    <h3>Installation des outils nécessaires</h3>
    <p>Dans ce guide, nous utiliserons les programmes suivants ; certains d'entre eux peuvent être remplacés, mais la combinaison proposée est recommandée pour une utilisation optimale :</p>
    <ul>
      <li>PostgreSQL, version 12 ou supérieure ;</li>
      <li>Node.js, version 12 ou supérieure ;</li>
      <li>NPM, version 6 ou supérieure ;</li>
      <li>nginx.</li>
    </ul>
    <p>On commence par ajouter les dépôts de Node.js, pour avoir les dernières versions (ici, la 14.x LTS) :</p>
    <pre><code class="hljs language-bash">curl -sL https://rpm.nodesource.com/setup_14.x | sudo bash -
</code></pre>
    <p>On installe ensuite les outils sus-mentionnés ; aucune remarque particulière sauf pour PostgreSQL, qui nécessite de suivre <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-centos-7">une procédure spécifique</a> ; sur CentOS, on fera par exemple :</p>
    <pre><code class="hljs language-bash">yum install nodejs nginx
</code></pre>
    <h3>Création de la base de données PostgreSQL</h3>
    <p>Toutes les tables nécessaires à l'API sont créées par l'<a href="https://fr.wikipedia.org/wiki/Mapping_objet-relationnel">ORM</a>, mais la base de données, ainsi qu'un utilisateur disposant des pleins droits sur celle-ci, doivent être créés manuellement :</p>
    <pre><code class="hljs language-sql">sudo <span class="hljs-operator">-</span>u postgres psql
postgres<span class="hljs-operator">=</span># <span class="hljs-keyword">CREATE</span> DATABASE pi2p_api;
postgres<span class="hljs-operator">=</span># <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> pi2p_api <span class="hljs-keyword">WITH</span> ENCRYPTED PASSWORD <span class="hljs-string">'strongPassword'</span>;
postgres<span class="hljs-operator">=</span># <span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> DATABASE pi2p_api <span class="hljs-keyword">TO</span> pi2p_api;
</code></pre>
    <h3>Activation des services systemd</h3>
    <p>Pour le lancement automatique au démarrage, on active les services associés à <code>nginx</code> et PostgreSQL ; plus tard, une unité sera également crée pour l'API :</p>
    <pre><code class="hljs language-bash">systemctl <span class="hljs-built_in">enable</span> postgresql
systemctl <span class="hljs-built_in">enable</span> nginx
systemctl start postgresql
systemctl start nginx
</code></pre>
    <h3>Configuration de nginx</h3>
    <p>A titre indicatif, une configuration possible pour nginx est fournie ; des ajustements seront sans doute nécessaires avant la mise en production, et il faudra en particulier veiller à la sécurité des données, via une configuration HTTPS sûre.</p>
    <pre><code class="hljs language-nginx"><span class="hljs-attribute">user</span> nginx;
<span class="hljs-attribute">worker_processes</span> auto;
<span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;
<span class="hljs-attribute">pid</span> /run/nginx.pid;

<span class="hljs-comment"># Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.</span>
<span class="hljs-attribute">include</span> /usr/share/nginx/modules/<span class="hljs-regexp">*.conf</span>;

<span class="hljs-section">events</span> {
	<span class="hljs-attribute">worker_connections</span> <span class="hljs-number">1024</span>;
}

<span class="hljs-section">http</span> {
	<span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">'$remote_addr - $remote_user [$time_local] "$request" '</span>
					  <span class="hljs-string">'$status $body_bytes_sent "$http_referer" '</span>
					  <span class="hljs-string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;

	<span class="hljs-attribute">access_log</span>  /var/log/nginx/access.log  main;

	<span class="hljs-attribute">sendfile</span>            <span class="hljs-literal">on</span>;
	<span class="hljs-attribute">tcp_nopush</span>          <span class="hljs-literal">on</span>;
	<span class="hljs-attribute">tcp_nodelay</span>         <span class="hljs-literal">on</span>;
	<span class="hljs-attribute">keepalive_timeout</span>   <span class="hljs-number">65</span>;
	<span class="hljs-attribute">types_hash_max_size</span> <span class="hljs-number">2048</span>;

	<span class="hljs-attribute">include</span>             /etc/nginx/mime.types;
	<span class="hljs-attribute">default_type</span>        application/octet-stream;

	<span class="hljs-comment"># Load modular configuration files from the /etc/nginx/conf.d directory.</span>
	<span class="hljs-comment"># See http://nginx.org/en/docs/ngx_core_module.html#include</span>
	<span class="hljs-comment"># for more information.</span>
	<span class="hljs-attribute">include</span> /etc/nginx/conf.d/<span class="hljs-regexp">*.conf</span>;

	<span class="hljs-section">server</span> {
		<span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span> http2;
		<span class="hljs-attribute">listen</span>       [::]:<span class="hljs-number">80</span> http2;
		<span class="hljs-attribute">server_name</span>  example.com;
		<span class="hljs-attribute">root</span>         /var/www/pi2p;

		<span class="hljs-comment"># Force redirect to the HTTPS website</span>
		<span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://$server_name$request_uri;
	}

	<span class="hljs-section">server</span> {
		<span class="hljs-attribute">listen</span>       <span class="hljs-number">443</span> ssl http2 default_server;
		<span class="hljs-attribute">listen</span>       [::]:<span class="hljs-number">443</span> ssl http2 default_server;
		<span class="hljs-attribute">server_name</span>  example.com;
		<span class="hljs-attribute">root</span>         /var/www/pi2p;

		<span class="hljs-attribute">ssl_certificate</span> <span class="hljs-string">"/path/to/your/tls/cert"</span>;
		<span class="hljs-attribute">ssl_certificate_key</span> <span class="hljs-string">"/path/to/your/tls/key"</span>;
		<span class="hljs-attribute">ssl_session_cache</span> shared:SSL:<span class="hljs-number">1m</span>;
		<span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;
		<span class="hljs-attribute">ssl_protocols</span> TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>;
		<span class="hljs-attribute">ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
		<span class="hljs-attribute">ssl_prefer_server_ciphers</span> <span class="hljs-literal">on</span>;

		<span class="hljs-attribute">location</span> / {
			<span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:3000/;
			<span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">"upgrade"</span>;
			<span class="hljs-attribute">proxy_set_header</span> Upgrade $http_upgrade;
		}
	}
}
</code></pre>
    <h2>Installation de l'API et configuration</h2>
    <p>Ici, nous installerons l'API dans <code>/var/www/pi2p</code> ; la procédure standard consiste soit :</p>
    <ul>
      <li>à cloner directement un répertoire Git, ce qui permet éventuellement de bénéficier des mises à jour automatiques ;</li>
      <li>à récupérer une version, puis à décompresser l'archive sur le serveur.</li>
    </ul>
    <p>Nous détaillerons ici la procédure utilisant Git :</p>
    <pre><code class="hljs language-bash"><span class="hljs-built_in">cd</span> /var/www
git <span class="hljs-built_in">clone</span> https://github.com/frareb/pi2p.git
<span class="hljs-built_in">cd</span> pi2p/Task04 &#x26;&#x26; npm ci --only=prod
</code></pre>
    <h3>Création de l'unité systemd</h3>
    <p>Afin de faciliter la maintenance, et pour permettre le rechargement automatique lors des mises à jours, nous allons créer une unité <em>systemd</em> suivant le modèle (à mettre dans <code>/etc/systemd/system</code> par exemple) :</p>
    <pre><code class="hljs language-routeros">[Unit]
<span class="hljs-attribute">Description</span>=PI2P API<span class="hljs-built_in"> server
</span><span class="hljs-attribute">After</span>=syslog.target
<span class="hljs-attribute">After</span>=network.target
<span class="hljs-attribute">Requires</span>=postgresql.service

[Service]
<span class="hljs-attribute">RestartSec</span>=2s
<span class="hljs-attribute">Type</span>=simple
<span class="hljs-attribute">User</span>=nginx
<span class="hljs-attribute">Group</span>=nginx
<span class="hljs-attribute">WorkingDirectory</span>=/var/www/pi2p/Task04
<span class="hljs-attribute">ExecStart</span>=/usr/bin/node bin/www
<span class="hljs-attribute">Restart</span>=always
<span class="hljs-attribute">Environment</span>=NODE_ENV=production <span class="hljs-attribute">DSN</span>=postgres://pi2p_api:strongPassword@localhost:5432/pi2p_api <span class="hljs-attribute">PORT</span>=3000

[Install]
<span class="hljs-attribute">WantedBy</span>=multi-user.target
</code></pre>
    <p>Cette unité peut ensuite être activée au démarrage via :</p>
    <pre><code class="hljs language-bash">systemctl <span class="hljs-built_in">enable</span> pi2p
systemctl start pi2p
</code></pre>
    <h3>Création d'une règle pour la mise à jour automatique</h3>
    <p>L'unité ci-dessus n'est pas défaut accessible qu'au superutilisateur ; les mises à jour automatiques dépendent du rechargement de cette unité par l'utilisateur <code>nginx</code>, on peut donc ajouter une règle Polkit dans <code>/etc/polkit-1/rules.d/51-nginx-pi2p.rules</code>, afin de permettre au serveur de se relancer lui-même :</p>
    <pre><code class="hljs language-js"><span class="hljs-comment">// Allow nginx to manage pi2p.service</span>
polkit.addRule(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">action, subject</span>) </span>{
		<span class="hljs-keyword">if</span>(     action.id == <span class="hljs-string">"org.freedesktop.systemd1.manage-units"</span> &#x26;&#x26;
				action.lookup(<span class="hljs-string">"unit"</span>) == <span class="hljs-string">"pi2p.service"</span> &#x26;&#x26;
				subject.user == <span class="hljs-string">"nginx"</span>) {
				<span class="hljs-keyword">return</span> polkit.Result.YES;
		}
});
</code></pre>
    <h3>Génération des premières clefs</h3>
    <p>Le serveur est maintenant accessible à l'adresse indiquée à <code>nginx</code>, mais aucun accès n'est disponible ; pour en créer, il faut se reconnecter à PostgreSQL, puis insérer manuellement deux clefs (au moins une) :</p>
    <ul>
      <li>une clef d'administrateur, permettant un accès complet aux points d'accès ;</li>
      <li>une clef de déploiement pour les hooks Git(hub).</li>
    </ul>
    <p>On génère d'abord deux clefs via Node.js à la racine du projet :</p>
    <pre><code class="hljs language-js"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">"crypto"</span>);
<span class="hljs-keyword">const</span> crs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"crypto-random-string"</span>);

<span class="hljs-comment">// Le contenu de 'a' est la clef administrateur</span>
<span class="hljs-keyword">let</span> a = crs({<span class="hljs-attr">length</span>: <span class="hljs-number">64</span>, <span class="hljs-attr">type</span>:<span class="hljs-string">"base64"</span>});

<span class="hljs-comment">// Le hash généré doit être mis en base de données</span>
crypto.createHash(<span class="hljs-string">"sha256"</span>).update(a).digest(<span class="hljs-string">"base64"</span>);

<span class="hljs-comment">// Le contenu de 'b' est la clef de déploiement,</span>
<span class="hljs-comment">// elle est inséréer **non-hachée** en base de données.</span>
<span class="hljs-keyword">let</span> b = crs({<span class="hljs-attr">length</span>: <span class="hljs-number">64</span>, <span class="hljs-attr">type</span>:<span class="hljs-string">"base64"</span>});
</code></pre>
    <p>Une fois les deux clefs obtenues, il suffit de les insérer via :</p>
    <pre><code class="hljs language-sql">sudo <span class="hljs-operator">-</span>u postgres psql
postgres<span class="hljs-operator">=</span># \u pi2p_api;
pi2p_api<span class="hljs-operator">=</span># <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> "Groups"(name, description, "createdAt", "updatedAt") <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'admin'</span>, <span class="hljs-string">'Groupe d''administration, avec accès complet'</span>, NOW(), NOW());
pi2p_api<span class="hljs-operator">=</span># <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> "ApiKeys"(key, description, "createdAt", "updatedAt", "groupId") <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'clefAdmin'</span>, <span class="hljs-string">'Clef d''administration principale'</span>, NOW(), NOW(), <span class="hljs-number">1</span>);
pi2p_api<span class="hljs-operator">=</span># <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> "Groups"(name, description, "createdAt", "updatedAt") <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'deploy'</span>, <span class="hljs-string">'Groupe de déploiement'</span>, NOW(), NOW());
pi2p_api<span class="hljs-operator">=</span># <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> "ApiKeys"(key, description, "createdAt", "updatedAt", "groupId") <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'clefDeploy'</span>, <span class="hljs-string">'Clef pour le déploiement via Github'</span>, NOW(), NOW(), <span class="hljs-number">1</span>);
</code></pre>
    <h2>Quelques erreurs à ne pas faire</h2>
    <h3><code>npm install</code></h3>
    <p>Sur un serveur, on ne souhaite pas installer les outils de développement, on privilégiera ainsi <code>npm install --only=prod</code>. Dans notre cas, on ne souhaite pas que le fichier de verouillage (<em>lock</em>) soit mis à jour par le serveur, on fera donc un <code>npm ci --only=prod</code>, qui répond à nos deux exigences.</p>
    <h3>Des installations globales</h3>
    <p>Les installations globales via NPM sont à éviter absolument, car elles ne permettent pas de déployer d'autres applications sur le serveur, et ne sont pas mises à jour automatiquement via les <em>hooks</em>.</p>
    <h3>Lancement des <em>seeders</em></h3>
    <p>Les <em>seeders</em> sont des données utilisées pour les tests, les insérer sur un serveur de production crééra des failles de sécurité, notamment au vu des clefs API simplistes utilisées pour les tests. On privilégiera ainsi l'ajout manuel des données via des points d'accès API.</p>
  </body>
</html>
