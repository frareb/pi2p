<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Gestion de la base de données</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.2/styles/github.min.css">
  </head>
  <body>
    <h1>Gestion de la base de données</h1>
    <p>Plutôt que de travailler en direct avec la base de données PostgreSQL, on utilise l'<a href="https://fr.wikipedia.org/wiki/Mapping_objet-relationnel"><abbr title="Object-Relational Mapping">ORM</abbr></a> <a href="https://sequelize.org/">Sequelize</a>, permettant de gérer plus facilement la base de données. Le principe est que la base est abstraite en modèles, qui sont compatibles avec les modèles de donnés Javascript.</p>
    <h2>Connexion à la base</h2>
    <p>La configuration des bases de données s'effectue via le fichier <code>config/config.json</code> ; pour le développement, une base de données locale PostgreSQL est utilisée, de nom <code>pi2p</code>, et avec un utilisateur éponyme disposant de tous les droits sur la base.</p>
    <p>En production, la base est configurée en utilisant la variable d'environnement <code>DSN</code> ; cette variable peut être réglée dans une unité <em>systemd</em> par exemple ; pour les tests, on pourra lancer le programme localement comme suit :</p>
    <pre><code class="hljs language-bash">NODE_ENV=production DSN=postgres://user:pass@example.com:port/database node www/bin
</code></pre>
    <h2>Modélisation des données et relations</h2>
    <p>Chaque base de données a pour correspondance un modèle situé dans le dossier <code>models/</code> ; il dispose des mêmes champs que la table en base de données. Les types, eux, sont nécessairement différents, et c'est l'<abbr title="Object-Relational Mapping">ORM</abbr> qui assure la conversion, lorsqu'elle est nécessaire. Par exemple, un champ <em>DATE</em> en JS sera converti en champ <em>DATE</em> SQL lors de l'insertion des données.</p>
    <p>Une fonctionnalité intéressante, qui étend les possibilités de SQL, sont les relations entre modèles ; sur une clef étrangère, il est possible, d'avoir des relations bi-directionnelles. Par exemple, une <em>gateway</em> dispose de plusieurs capteurs, et chaque capteur appartient à une unique <em>gateway</em> ; c'est une relation 1:N, on associe donc <em>Sensors</em> à <em>Gateways</em> via une relation <code>hasMany</code>, et <em>Gateways</em> à <em>Sensors</em> via une relation <code>belongsTo</code>, en spécifiant sur chacun <strong>la clef étrangère du modèle multiple</strong>, ici <em>Sensors</em>.</p>
    <p>D'autres relations sont possibles, et documentées <a href="https://sequelize.org/v5/manual/associations.html">dans le manuel</a> ; la procèdure pour trouver les fonctions à utiliser est d'abord de définir la relation :</p>
    <ul>
      <li>1:1 : on ajoute <code>hasOne</code> des deux côtés, chacun référence la clef étrangère de l'autre, ou une seule table dispose d'une clef ;</li>
      <li>1:N : c'est le cas le plus courant, on ajoute alors <code>belongsTo</code> au modèle ayant la clef et <code>hasMany</code> à l'autre modèle ;</li>
      <li>N:N : l'une des tables aura <code>hasMany</code> et l'autre <code>belongsToMany</code>, selon un choix plus ou moins arbitraire.</li>
    </ul>
    <h2>Migrations</h2>
    <p>Les migrations sont utilisées pour créer automatiquement les tables en base de données. <strong>Elles ne sont pas absoluement nécessaires</strong>, mais permettent de suivre les modifications sur les tables en utilisant un gestionnaire de version (Git par exemple), et de s'assurer que la base de données correspond bien à la version du code actuellement déployée.</p>
    <p>Pour lancer les migrations, il suffit d'exécuter la commande <code>sequelize db:migrate</code> après avoir installé le paquet <code>sequelize-cli</code> ; si la commande échoue, il faut vérifier les identifiants de la base de données. Pour annuler les migrations, il suffit d'exécuter la commande <code>sequelize db:migrate:undo:all</code>.</p>
    <h2>Données de test</h2>
    <p>Les <em>seeders</em> sont un moyen simple d'obtenir des données de test pendant la phase de développement. Ils consistent en une addition brute de données dans les tables ; pour les obtenir, il suffit de lancer <code>sequelize db:seed:all</code>. Pour les supprimer, il faut exécuter la commande <code>sequelize db:seed:undo:all</code>.</p>
    <p>Le fonctionnement de Sequelize est très vaste, et seuls quelques points spécifiques au projet sont abordés ici ; en particulier, le travail avec les modèles (<code>find</code>, <code>update</code> et <code>delete</code>) n'est pas précisé, car il est bien détaillé dans la <a href="https://sequelize.org/v5/class/lib/model.js~Model.html">documentation des modèles</a>.</p>
  </body>
</html>
